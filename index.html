<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Smart Data</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #1a1a1a, #101020); color: #fff; margin: 0; padding: 0 0 70px 0; overflow-x: hidden; }
        .header { background-color: #0d0d1a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #333; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .menu-btn { font-size: 24px; cursor: pointer; color: #fff; }
        .header h1 { margin: 0; background: linear-gradient(90deg, #ff4d4d, #ff8c1a); -webkit-background-clip: text; color: transparent; font-size: 22px; font-weight: bold; }

        /* Sidebar */
        #sideMenu { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: #1e1e2d; z-index: 2000; transition: 0.3s; padding-top: 20px; overflow-y: auto; }
        #sideMenu.active { left: 0; }
        
        .side-title { padding: 15px 25px; font-size: 14px; color: #ff8c1a; text-transform: uppercase; font-weight: bold; border-bottom: 1px solid #333; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        #dynamicCategories { display: none; background: #161625; transition: 0.3s; }
        #dynamicCategories.show { display: block; }
        
        .side-link { padding: 12px 25px; color: #ddd; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #222; cursor: pointer; text-decoration: none; font-size: 14px; }
        .side-link:hover { background: #252538; }
        
        .fa-chevron-down { transition: transform 0.3s; font-size: 12px; }
        .rotate { transform: rotate(180deg); }

        .side-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1900; display: none; }
        .side-overlay.active { display: block; }

        /* Movie Grid */
        .movie-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
        .movie-card { background: #1f1f2e; border-radius: 8px; overflow: hidden; border: 1px solid #333; transition: transform 0.2s; }
        .movie-card:active { transform: scale(0.95); }
        .movie-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block; }
        .movie-card p { padding: 8px 8px 2px 8px; font-size: 11px; font-weight: bold; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .category-badge { color: #ff8c1a; padding: 0 8px 8px 8px; font-size: 9px; display: block; opacity: 0.8; }

        /* Pagination Styling */
        .pagination-container { display: flex; justify-content: center; align-items: center; gap: 15px; padding: 20px 0; margin-bottom: 20px; }
        .page-btn { background: linear-gradient(90deg, #ff4d4d, #ff8c1a); color: white; border: none; padding: 8px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 13px; }
        .page-btn:disabled { background: #333; color: #777; cursor: not-allowed; }
        #pageNumber { font-size: 14px; font-weight: bold; color: #ff8c1a; }

        /* Smooth Animation for Page Change */
        .fade-anim { animation: fadeInUp 0.6s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal */
        .movie-detail { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); padding: 20px; z-index: 3000; overflow-y: auto; }
        .detail-content { max-width: 500px; margin: 40px auto; background: #2a2a2a; padding: 20px; border-radius: 12px; position: relative; }
        .close-btn { position: absolute; top: -45px; right: 0; font-size: 40px; color: #ff4d4d; cursor: pointer; }
        #inModalPlayerContainer { width: 100%; margin-bottom: 15px; display: none; }
        #inModalVideoPlayer { width: 100%; border-radius: 8px; aspect-ratio: 16/9; }
        #modalImg { width:100%; border-radius:8px; aspect-ratio: 16/9; object-fit: cover; }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* Ad Popup */
        #adPopup { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); display: none; justify-content: center; align-items: center; z-index: 10000; }
        #adIframeContainer { width: 100%; height: 100%; position: relative; border-radius: 10px; overflow: hidden; }
        #adIframe { width: 100%; height: 100%; border: none; }
        #adTimer { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; }

        /* Bottom Nav */
        #bottomNav { position: fixed; bottom: 0; width: 100%; height: 65px; background: #1e1e2d; display: flex; border-top: 2px solid #ff8c1a; z-index: 1000; }
        .nav-item-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #aaa; cursor: pointer; }
        .nav-item-btn.active { color: #ff8c1a; }
        .nav-item-btn i { font-size: 18px; }
        .nav-item-btn span { font-size: 9px; margin-top: 4px; }
        
        .spinner { border: 4px solid #333; border-top: 4px solid #ff8c1a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="side-overlay" onclick="toggleSideMenu()"></div>
<div id="sideMenu">
    <div class="side-title" style="cursor: default;">Shortcuts</div>
    <div class="side-link" onclick="handleNavClick('popular', null); toggleSideMenu()">
        <i class="fas fa-star" style="color: gold;"></i> Popular Content
    </div>
    
    <div class="side-title" onclick="toggleCategoryMenu()">
        <span>All Categories</span>
        <i class="fas fa-chevron-down" id="catArrow"></i>
    </div>
    <div id="dynamicCategories"></div>
</div>

<div class="header">
    <div class="header-left">
        <i class="fas fa-bars menu-btn" onclick="toggleSideMenu()"></i>
        <h1 onclick="window.location.reload()">Smart Data</h1>
    </div>
</div>

<div id="loadingSpinner" style="display:none; text-align:center; padding:50px;">
    <div class="spinner"></div>
</div>

<div id="movieGrid" class="movie-grid"></div>

<div class="pagination-container">
    <button id="prevBtn" class="page-btn" onclick="changePage(-1)">
        <i class="fas fa-chevron-left"></i> Back
    </button>
    <span id="pageNumber">1</span>
    <button id="nextBtn" class="page-btn" onclick="changePage(1)">
        Next <i class="fas fa-chevron-right"></i>
    </button>
</div>

<div id="modal" class="movie-detail">
    <div class="detail-content">
        <span class="close-btn" onclick="closeDetail()">&times;</span>
        <div id="inModalPlayerContainer">
            <video id="inModalVideoPlayer" controls controlsList="nodownload" playsinline></video>
        </div>
        <img id="modalImg" src="">
        <h2 id="modalTitle" style="text-align:center; margin:15px 0; font-size: 18px;"></h2>
        
        <button id="playBtn" class="btn" style="background:#ff4d4d; color:white;">Play Video</button>
        <button id="downloadBtn" class="btn" style="background:#3f51b5; color:white;">Download</button>
        
        <button id="favoriteBtn" class="btn" style="display:none;"></button>
    </div>
</div>

<div id="adPopup">
    <div id="adIframeContainer">
        <div id="adTimer">15</div>
        <iframe id="adIframe" src=""></iframe>
    </div>
</div>

<div id="bottomNav">
    <div class="nav-item-btn active" onclick="handleNavClick('all', this)">
        <i class="fas fa-home"></i> <span>Home</span>
    </div>
    <div class="nav-item-btn" onclick="handleNavClick('Desi', this)">
        <i class="fas fa-video"></i> <span>Desi</span>
    </div>
    <div class="nav-item-btn" onclick="handleNavClick('Boy', this)">
        <i class="fas fa-male"></i> <span>Boy</span>
    </div>
    <div class="nav-item-btn" onclick="handleNavClick('Girl', this)">
        <i class="fas fa-female"></i> <span>Girl</span>
    </div>
    <div class="nav-item-btn" onclick="handleNavClick('favorites', this)">
        <i class="fas fa-heart"></i> <span>Favorites</span>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB68ACKzIXxsjOUPYIz-Kkr_BzTDHb0PTk",
        databaseURL: "https://smart-data-fa459-default-rtdb.firebaseio.com",
        projectId: "smart-data-fa459",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allContent = [];
    let popularContent = [];
    let filteredData = [];
    
    let currentPage = 1;
    const itemsPerPage = 20;

    const adLinks = [
        "https://www.effectivegatecpm.com/etnvcsg5?key=8cdf22590b8d8a5148ae31d2551bbe25",
        "https://www.effectivegatecpm.com/trsd2yif?key=abc53a0d90802a614242e97af96fd662",
        "https://www.effectivegatecpm.com/ynw0tz2k3x?key=d610eba80f701ad43ddbbefa958a170b",
        "https://www.effectivegatecpm.com/fgjvc6xp?key=02a55463acca337410ce3bf28d4c13fa",
        "https://www.effectivegatecpm.com/uck9x0wk6?key=11fca88e86f0d00b67543ac7a783e47f",
        "https://www.effectivegatecpm.com/zq5rzngg?key=a6fd58330a330c83ef94c1f7b6534856",
        "https://www.effectivegatecpm.com/dqm7ya0myx?key=976aa4962ea641f87639dfc784b35969",
        "https://www.effectivegatecpm.com/ht895npk?key=1dfeb60a3b20c38bc592436e3ccf9a82",
        "https://www.effectivegatecpm.com/b7gn1rctv?key=a6df49ee2755a88078fad4af6ebd06bf",
        "https://www.effectivegatecpm.com/yz4z5szmf?key=73186bcddd33133e4b3c585292f10bde",
        "https://www.effectivegatecpm.com/s2mq62in?key=b17a7185381af8ce5baa404d8817d708",
        "https://www.effectivegatecpm.com/cm2npj3b6n?key=bbdca23bff7d7d54853f830d7c238ddf",
        "https://www.effectivegatecpm.com/uyz2avfp?key=af05da8c47fc0d441624224a14c722a6",
        "https://www.effectivegatecpm.com/uz50mzu3f?key=efec633d14ae4a27a4a0aa1aa41c9c7e"
    ];

    function initApp() {
        document.getElementById('loadingSpinner').style.display = 'block';

        db.ref('categories').on('value', (snapshot) => {
            const catDiv = document.getElementById('dynamicCategories');
            catDiv.innerHTML = '';
            let categories = [];
            const excluded = ['Desi', 'Boy', 'Girl'];
            snapshot.forEach(child => { categories.push(child.val()); });
            categories.reverse().forEach(catName => {
                if(!excluded.includes(catName)) {
                    catDiv.innerHTML += `
                        <div class="side-link" onclick="handleNavClick('${catName}', null); toggleSideMenu()">
                            <i class="fas fa-folder-open"></i> ${catName}
                        </div>`;
                }
            });
        });

        db.ref('movies').on('value', (mSnap) => {
            allContent = [];
            mSnap.forEach(snap => { allContent.push({...snap.val(), key: snap.key}); });
            allContent.reverse();

            db.ref('popular_movies').on('value', (pSnap) => {
                popularContent = [];
                pSnap.forEach(snap => { popularContent.push({...snap.val(), key: snap.key}); });
                popularContent.reverse();
                
                handleNavClick('all', document.querySelector('.nav-item-btn'));
                document.getElementById('loadingSpinner').style.display = 'none';
            });
        });

        setTimeout(() => { showAdPopup(null, 0); }, 100);
    }

    function handleNavClick(filter, el) {
        if(el) {
            document.querySelectorAll('.nav-item-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
        
        currentPage = 1;
        let combined = [...allContent, ...popularContent];
        if(filter === 'all') filteredData = combined;
        else if(filter === 'popular') filteredData = popularContent;
        else if(filter === 'favorites') {
            const favs = JSON.parse(localStorage.getItem('favs') || '[]');
            filteredData = combined.filter(i => favs.includes(i.key));
        } else {
            filteredData = combined.filter(i => i.category === filter);
        }
        renderGrid();
    }

    function renderGrid() {
        const grid = document.getElementById('movieGrid');
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = filteredData.slice(start, end);

        grid.classList.remove('fade-anim');
        void grid.offsetWidth; 
        grid.classList.add('fade-anim');

        grid.innerHTML = paginatedItems.map(item => `
            <div class="movie-card" onclick="openDetail('${item.key}')">
                <img src="${item.img}">
                <p>${item.title}</p>
                <span class="category-badge">${item.category || 'Content'}</span>
            </div>
        `).join('') || '<p style="grid-column:1/3; text-align:center; padding:20px;">No Content Found</p>';

        updatePagination();
    }

    function changePage(step) {
        currentPage += step;
        renderGrid();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        document.getElementById('prevBtn').disabled = (currentPage === 1);
        document.getElementById('nextBtn').disabled = (currentPage >= totalPages || totalPages === 0);
        document.getElementById('pageNumber').innerText = `Page ${currentPage} / ${totalPages || 1}`;
    }

    function toggleCategoryMenu() {
        const catDiv = document.getElementById('dynamicCategories');
        const arrow = document.getElementById('catArrow');
        catDiv.classList.toggle('show');
        arrow.classList.toggle('rotate');
    }

    function openDetail(key) {
        const item = [...allContent, ...popularContent].find(i => i.key === key);
        if(!item) return;

        document.getElementById('modalTitle').innerText = item.title;
        document.getElementById('modalImg').src = item.img;
        document.getElementById('modalImg').style.display = 'block';
        document.getElementById('inModalPlayerContainer').style.display = 'none';
        
        document.getElementById('playBtn').onclick = () => {
            if(item.play) {
                document.getElementById('inModalVideoPlayer').src = item.play;
                document.getElementById('inModalPlayerContainer').style.display = 'block';
                document.getElementById('modalImg').style.display = 'none';
                document.getElementById('inModalVideoPlayer').play();
            } else { alert("Video link not available."); }
        };

        // Download button will now show ad first, then open the item.play link
        document.getElementById('downloadBtn').onclick = () => { 
            if(item.play) {
                showAdPopup(item.play, 15); 
            } else {
                alert("Download link not available.");
            }
        };

        document.getElementById('modal').style.display = 'block';
    }

    function showAdPopup(url, time) {
        const adDiv = document.getElementById("adPopup");
        const timerEl = document.getElementById("adTimer");
        const iframe = document.getElementById("adIframe");
        const randomAd = adLinks[Math.floor(Math.random() * adLinks.length)];
        adDiv.style.display = 'flex';
        iframe.src = randomAd; 
        let timeLeft = time;
        timerEl.innerText = timeLeft;
        const interval = setInterval(() => {
            timeLeft--;
            timerEl.innerText = timeLeft;
            if(timeLeft <= 0) {
                clearInterval(interval);
                adDiv.style.display = 'none';
                iframe.src = '';
                // Opens the admin-provided link after timer
                if(url) window.open(url, '_blank');
            }
        }, 1000);
    }

    function closeDetail() {
        document.getElementById('inModalVideoPlayer').pause();
        document.getElementById('modal').style.display = 'none';
    }

    function toggleSideMenu() {
        document.getElementById('sideMenu').classList.toggle('active');
        document.querySelector('.side-overlay').classList.toggle('active');
    }

    initApp();
</script>
</body>
</html>

